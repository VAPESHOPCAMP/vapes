<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V4PESHOPCAMP | Oficial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --neon: #00ff41; --bg: #0a0a0a; --card: #161616; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        .navbar { position: sticky; top: 0; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); z-index: 1000; border-bottom: 1px solid #333; height: 60px; box-sizing: border-box;}
        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: #111; z-index: 2000; transition: 0.4s; padding: 25px; border-right: 1px solid var(--neon); box-sizing: border-box;}
        .sidebar.active { left: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 1500; }
        .screen { padding: 20px; display: none; max-width: 600px; margin: auto; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--card); border-radius: 18px; padding: 18px; margin-bottom: 20px; border: 1px solid #252525; }
        .btn-main { background: var(--neon); color: black; border: none; width: 100%; padding: 14px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #1a1a1a; color: white; box-sizing: border-box; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.8rem; }
        .admin-table th, .admin-table td { padding: 8px; border: 1px solid #333; text-align: left; }
        .sabor-row { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 8px; margin: 4px 0; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

    <div class="sidebar" id="sidebar">
        <h3 id="side-user-name" style="color:var(--neon)">V4PESHOPCAMP</h3>
        <div onclick="showScreen('screen-catalogo'); toggleMenu();" style="padding:15px; cursor:pointer;"><i class="fas fa-store"></i> Tienda</div>
        <div onclick="showScreen('screen-perfil'); toggleMenu();" style="padding:15px; cursor:pointer;"><i class="fas fa-user-edit"></i> Mi Perfil</div>
        <div id="btn-contacto-menu" style="padding:15px; cursor:pointer; color:#25D366;"><i class="fab fa-whatsapp"></i> Contactar Due침o</div>
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <div onclick="openAdmin()" style="padding:15px; cursor:pointer; color: #555;"><i class="fas fa-lock"></i> Panel Due침o</div>
    </div>

    <nav class="navbar" id="main-nav" style="display:none;">
        <i class="fas fa-bars" onclick="toggleMenu()" style="font-size:1.5rem;"></i>
        <div id="nav-logo" style="font-weight:bold; color:var(--neon);">V4PESHOPCAMP</div>
        <div onclick="showScreen('screen-carrito')" style="position:relative; cursor:pointer;">
            <i class="fas fa-shopping-basket" style="font-size:1.5rem;"></i>
            <span id="cart-count" style="position:absolute; top:-10px; right:-10px; background:red; color:white; border-radius:50%; padding:2px 6px; font-size:10px; font-weight:bold;">0</span>
        </div>
    </nav>

    <div id="screen-registro" class="screen active">
        <div class="card" style="text-align:center; margin-top:50px;">
            <div id="logo-registro"><h1>V4PESHOPCAMP</h1></div>
            <input type="text" id="reg-nombre" placeholder="Tu Nombre Completo">
            <input type="tel" id="reg-tel" placeholder="WhatsApp (10 d칤gitos)">
            <button class="btn-main" onclick="handleRegistro()">ENTRAR A LA TIENDA</button>
        </div>
    </div>

    <div id="screen-catalogo" class="screen">
        <div id="lista-productos"></div>
    </div>

    <div id="screen-carrito" class="screen">
        <h2>Mi Carrito</h2>
        <div id="cart-items"></div>
        <div id="cart-total" class="card" style="margin-top:15px;"></div>
        <button class="btn-main" style="background:#25D366; color:white;" onclick="enviarPedidoWhatsApp()">ENVIAR PEDIDO</button>
        <button class="btn-main" style="background:#333;" onclick="showScreen('screen-catalogo')">VOLVER</button>
    </div>

    <div id="screen-admin" class="screen">
        <h2 style="color:gold">Panel de Control</h2>
        
        <div class="card" style="border: 1px solid gold;">
            <h4>丘뙖잺 Configuraci칩n General</h4>
            <label>Tu n칰mero de WhatsApp (con 52):</label>
            <input type="tel" id="adm-whatsapp" placeholder="Ej: 529811234567">
            <button onclick="guardarConfig()" style="background:gold; color:black; border:none; padding:10px; border-radius:5px; width:100%; font-weight:bold;">Guardar N칰mero</button>
        </div>

        <div class="card">
            <h4>游닍 Subir Nuevo Producto</h4>
            <input type="text" id="adm-mod" placeholder="Modelo del Vape">
            <input type="number" id="adm-pre" placeholder="Precio ($)">
            <label>Foto del producto:</label>
            <input type="file" id="adm-file" accept="image/*">
            
            <div id="adm-sabores-group">
                <div style="display:flex; gap:5px;">
                    <input type="text" placeholder="Sabor" class="s-nom">
                    <input type="number" placeholder="Stock" class="s-cant" style="width:70px;">
                </div>
            </div>
            <button onclick="addSaborField()" style="background:#333; color:white; border:none; padding:8px; border-radius:5px; margin-top:5px;">+ Otro Sabor</button>
            <button id="btn-subir" class="btn-main" onclick="uploadProduct()">PUBLICAR PRODUCTO</button>
        </div>

        <h3>Clientes Registrados</h3>
        <div id="admin-clients-table" style="background:#111; border-radius:10px; overflow-x:auto;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, update, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyC829vfc_1p2iMuM3fMDutTGDyr7Ec1Ow4",
  authDomain: "tienda-8d621.firebaseapp.com",
  projectId: "tienda-8d621",
  storageBucket: "tienda-8d621.firebasestorage.app",
  messagingSenderId: "618116360548",
  appId: "1:618116360548:web:362c7a1cf052ac8870f271",
  measurementId: "G-1PCRNN5ZLT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        let cart = [];
        let miWhatsapp = "529810000000"; // Default

        window.toggleMenu = () => document.getElementById('sidebar').classList.toggle('active');
        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-carrito') renderCart();
        };

        // Escuchar Configuraci칩n (N칰mero y Logo)
        onValue(ref(db, 'configuracion'), (snap) => {
            const conf = snap.val();
            if(conf) {
                if(conf.whatsapp) {
                    miWhatsapp = conf.whatsapp;
                    document.getElementById('adm-whatsapp').value = miWhatsapp;
                    document.getElementById('btn-contacto-menu').onclick = () => window.open(`https://wa.me/${miWhatsapp}`);
                }
            }
        });

        window.handleRegistro = () => {
            const n = document.getElementById('reg-nombre').value;
            const t = document.getElementById('reg-tel').value;
            if(n && t) {
                localStorage.setItem('vape_user', JSON.stringify({nombre: n, tel: t}));
                location.reload();
            }
        };

        window.onload = () => {
            const user = JSON.parse(localStorage.getItem('vape_user'));
            if(user) {
                document.getElementById('screen-registro').classList.remove('active');
                document.getElementById('screen-catalogo').classList.add('active');
                document.getElementById('main-nav').style.display = 'flex';
                document.getElementById('side-user-name').innerText = "Hola, " + user.nombre.split(' ')[0];
            }
        };

        onValue(ref(db, 'productos'), (snap) => {
            const data = snap.val();
            const cont = document.getElementById('lista-productos');
            cont.innerHTML = "";
            for(let id in data) {
                const p = data[id];
                let sabs = "";
                for(let s in p.sabores) {
                    sabs += `<div class="sabor-row">
                        <span>${s} (${p.sabores[s]} disp)</span>
                        <button onclick="addToCart('${p.modelo}', '${s}', ${p.precio})" ${p.sabores[s]<=0?'disabled':''} style="background:var(--neon); border:none; padding:5px 10px; border-radius:5px; font-weight:bold; cursor:pointer;">${p.sabores[s]<=0?'X':'+'}</button>
                    </div>`;
                }
                cont.innerHTML += `<div class="card">
                    <img src="${p.imagen}" style="width:100%; border-radius:12px; height:200px; object-fit:contain; background:#000;">
                    <h3>${p.modelo}</h3>
                    <p style="color:var(--neon); font-size:1.2rem; font-weight:bold;">$${p.precio}</p>
                    ${sabs}
                </div>`;
            }
        });

        window.addToCart = (m, s, p) => {
            cart.push({m, s, p});
            document.getElementById('cart-count').innerText = cart.length;
        };

        function renderCart() {
            const cont = document.getElementById('cart-items');
            let total = cart.reduce((acc, i) => acc + i.p, 0);
            let envio = (total >= 200 || total === 0) ? 0 : 50;
            cont.innerHTML = cart.map(i => `<div class="card" style="padding:10px; margin-bottom:5px;">${i.m} (${i.s}) - $${i.p}</div>`).join('');
            document.getElementById('cart-total').innerHTML = `Subtotal: $${total}<br>Env칤o: $${envio}<br><b style="font-size:1.4rem;">TOTAL: $${total+envio}</b>`;
        }

        window.enviarPedidoWhatsApp = async () => {
            if(cart.length === 0) return;
            const user = JSON.parse(localStorage.getItem('vape_user'));
            let total = cart.reduce((acc, i) => acc + i.p, 0);
            let envio = total >= 200 ? 0 : 50;

            // Lealtad
            const cRef = ref(db, 'clientes/' + user.tel);
            const snap = await get(cRef);
            let d = snap.val() || { nombre: user.nombre, vapesComprados: 0, regalosDados: 0 };
            let nv = d.vapesComprados + cart.length;
            let nr = d.regalosDados || 0;
            if(nv >= 5) { nv -= 5; nr += 1; }
            update(cRef, { nombre: user.nombre, vapesComprados: nv, regalosDados: nr, ultimo: new Date().toLocaleString() });

            let msg = `*PEDIDO V4PESHOPCAMP*%0A*Cliente:* ${user.nombre}%0A*Productos:*%0A${cart.map(i=>`- ${i.m} (${i.s})`).join('%0A')}%0A*Total:* $${total+envio}`;
            window.open(`https://wa.me/${miWhatsapp}?text=${msg}`);
            cart = []; document.getElementById('cart-count').innerText = 0;
            showScreen('screen-catalogo');
        };

        // ADMIN
        window.guardarConfig = () => {
            const num = document.getElementById('adm-whatsapp').value;
            if(num) set(ref(db, 'configuracion/whatsapp'), num).then(()=>alert("N칰mero Guardado"));
        };

        window.uploadProduct = async () => {
            const btn = document.getElementById('btn-subir');
            const file = document.getElementById('adm-file').files[0];
            const mod = document.getElementById('adm-mod').value;
            const pre = document.getElementById('adm-pre').value;
            if(!file || !mod || !pre) return alert("Completa todos los campos");
            
            btn.disabled = true; btn.innerText = "Subiendo foto...";
            const storageRef = sRef(storage, 'productos/' + Date.now());
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            
            let sabs = {};
            document.querySelectorAll('.s-nom').forEach((el, i) => { 
                if(el.value) sabs[el.value] = parseInt(document.querySelectorAll('.s-cant')[i].value); 
            });

            push(ref(db, 'productos'), {modelo:mod, precio:parseInt(pre), imagen:url, sabores:sabs})
            .then(() => location.reload());
        };

        window.addSaborField = () => {
            const d = document.createElement('div');
            d.style.display = "flex"; d.style.gap = "5px"; d.style.marginTop = "5px";
            d.innerHTML = `<input type="text" placeholder="Sabor" class="s-nom"><input type="number" placeholder="Stock" class="s-cant" style="width:70px;">`;
            document.getElementById('adm-sabores-group').appendChild(d);
        };

        window.openAdmin = () => {
            if(prompt("Clave:") === "VAPESHOP1234X") {
                showScreen('screen-admin');
                onValue(ref(db, 'clientes'), (s) => {
                    const d = s.val();
                    let t = `<table class="admin-table"><tr><th>Cliente</th><th>Vapes</th><th>游꾸</th></tr>`;
                    for(let k in d) { t += `<tr><td>${d[k].nombre}<br>${k}</td><td>${d[k].vapesComprados}/5</td><td>${d[k].regalosDados}</td></tr>`; }
                    document.getElementById('admin-clients-table').innerHTML = t + `</table>`;
                });
            }
        };
    </script>
</body>
</html>
